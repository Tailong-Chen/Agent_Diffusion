# 📁 完整文件说明

## 创建的文件总览（新增）

### 🚀 核心训练脚本（3个）

| 文件 | 用途 | 重要性 |
|------|------|--------|
| `train_tiff_ldm.py` | ⭐⭐⭐ 主训练脚本 | **必需** |
| `generate_samples.py` | ⭐⭐⭐ 推理生成脚本 | **必需** |
| `check_tiff_data.py` | ⭐⭐ 数据检查工具 | 强烈推荐 |

### 📖 文档（4个）

| 文件 | 内容 | 适合人群 |
|------|------|----------|
| `QUICK_START.md` | ⭐⭐⭐ 5分钟快速开始 | **所有用户** |
| `TIFF_TRAINING_README.md` | ⭐⭐⭐ 完整使用指南 | **所有用户** |
| `README_TIFF_LDM.md` | ⭐⭐ 项目总览 | 需要了解全貌 |
| `HIGH_RES_GUIDE.md` | ⭐ 高分辨率训练指南 | 高级用户 |

### ⚙️ 配置和辅助（6个）

| 文件 | 用途 |
|------|------|
| `requirements_tiff_ldm.txt` | Python依赖列表 |
| `config_512.py` | 512×512配置 |
| `config_1024_optimized.py` | 1024×1024优化配置 |
| `train_high_res_example.py` | 高分辨率训练示例 |
| `quick_start.sh` | Linux/Mac快速启动脚本 |
| `quick_start.bat` | Windows快速启动脚本 |

---

## 🎯 使用流程（推荐）

### 第1步: 阅读文档（5分钟）

```bash
# 快速了解
cat QUICK_START.md

# 详细了解
cat TIFF_TRAINING_README.md
```

### 第2步: 安装依赖（5分钟）

```bash
pip install -r requirements_tiff_ldm.txt
```

### 第3步: 检查数据（2分钟）

```bash
python check_tiff_data.py --tiff_path your_data.tif
```

### 第4步: 开始训练（2-3天）

**方法A: 使用脚本（最简单）**
```bash
# Windows
quick_start.bat

# Linux/Mac
./quick_start.sh
```

**方法B: 命令行（推荐）**
```bash
python train_tiff_ldm.py \
    --tiff_path your_data.tif \
    --output_dir ./output_ldm \
    --image_size 1024 \
    --batch_size 2
```

### 第5步: 生成样本（10分钟）

```bash
python generate_samples.py \
    --checkpoint ./output_ldm/checkpoints/diffusion_epoch_250.pth \
    --num_samples 20
```

---

## 📊 核心脚本详解

### 1. train_tiff_ldm.py（832行）

**功能**:
- ✅ 自动读取TIFF堆栈
- ✅ 训练AutoencoderKL
- ✅ 训练Diffusion Model
- ✅ 自动保存checkpoints
- ✅ 生成训练曲线

**关键类**:
```python
# TIFF数据集类
class TiffStackDataset(Dataset)

# 配置类
class LDMConfig

# 训练器类
class LDMTrainer
```

**输出**:
```
output_ldm/
├── checkpoints/          # 模型权重
├── samples/              # 训练样本
└── training_history.png  # 训练曲线
```

### 2. generate_samples.py（277行）

**功能**:
- ✅ 加载训练好的模型
- ✅ 从噪声生成图像
- ✅ 保存PNG和TIFF
- ✅ 创建网格可视化
- ✅ 可视化去噪过程

**输出**:
```
generated_samples/
├── sample_0001.png       # 单独样本
├── sample_grid.png       # 网格图
└── sample_stack.tif      # TIFF堆栈
```

### 3. check_tiff_data.py（343行）

**功能**:
- ✅ 验证TIFF格式
- ✅ 检查图像尺寸和数量
- ✅ 分析数值范围
- ✅ 生成统计报告
- ✅ 提供训练建议

**输出**:
```
tiff_check/
├── sample_images.png     # 样本可视化
└── statistics.png        # 统计图表
```

---

## 💡 快速开始（3种方式）

### 🥇 方式1: 一键脚本（推荐新手）

```bash
# 1. 编辑quick_start.bat或quick_start.sh
# 2. 修改TIFF_PATH路径
# 3. 运行脚本
```

### 🥈 方式2: 命令行（推荐）

```bash
python train_tiff_ldm.py --tiff_path your_data.tif
```

### 🥉 方式3: Python导入（高级用户）

```python
from train_tiff_ldm import LDMConfig, LDMTrainer

config = LDMConfig(image_size=1024)
trainer = LDMTrainer(config, output_dir="./output", device="cuda")
# ... 自定义训练流程
```

---

## 🎓 学习路径

### 入门级
1. 阅读 `QUICK_START.md`
2. 运行 `check_tiff_data.py`
3. 使用 `quick_start.bat/.sh` 开始训练

### 进阶级
1. 阅读 `TIFF_TRAINING_README.md`
2. 使用命令行参数自定义训练
3. 分步训练（先AE后Diffusion）

### 高级
1. 阅读所有文档
2. 修改配置文件（config_*.py）
3. 渐进式训练（256→512→1024）
4. 自定义训练循环

---

## 📈 预期效果

### 训练时间（32GB显存）

| 分辨率 | 完整训练 | 推荐 |
|--------|----------|------|
| 256×256 | 2-3小时 | 快速测试 |
| 512×512 | 10-15小时 | ⭐ **最佳平衡** |
| 1024×1024 | 2-3天 | 最高质量 |

### 显存使用

| 阶段 | 512×512 | 1024×1024 |
|------|---------|-----------|
| 训练 | 18-24GB | 28-32GB |
| 推理 | 8-12GB | 15-20GB |

---

## ⚠️ 重要提示

### 必须修改的地方

1. **TIFF路径**:
   - `quick_start.bat`: 第13行
   - `quick_start.sh`: 第14行

2. **输出目录** (可选):
   - 默认: `./output_ldm`
   - 修改: `--output_dir`参数

### 常见错误

1. **CUDA OOM**: 减小`--batch_size`
2. **TIFF读取失败**: 安装`tifffile`
3. **模块找不到**: 安装`requirements_tiff_ldm.txt`

---

## 🔗 文件依赖关系

```
train_tiff_ldm.py
├── 依赖: requirements_tiff_ldm.txt
├── 参考: config_*.py
├── 输出: checkpoints/, samples/
└── 使用: AutoencoderKL, DiffusionModelUNet

generate_samples.py
├── 依赖: requirements_tiff_ldm.txt
├── 输入: checkpoints/*.pth
└── 输出: generated_samples/

check_tiff_data.py
├── 依赖: tifffile (或 PIL)
├── 输入: *.tif
└── 输出: 数据报告, 可视化
```

---

## 📚 推荐阅读顺序

1. ⭐ `QUICK_START.md` - 5分钟快速入门
2. ⭐ `TIFF_TRAINING_README.md` - 完整使用指南
3. `README_TIFF_LDM.md` - 项目总览
4. `HIGH_RES_GUIDE.md` - 高分辨率优化（如需要）

---

## 🎁 额外功能

### 支持的功能

- ✅ TIFF堆栈自动读取
- ✅ 自动数据归一化
- ✅ 训练/验证集自动划分
- ✅ 混合精度训练（FP16）
- ✅ 梯度累积
- ✅ 梯度裁剪
- ✅ 实时进度显示
- ✅ 自动保存checkpoints
- ✅ 训练曲线可视化
- ✅ 样本质量监控
- ✅ 显存使用监控

### 未来可扩展

- [ ] 条件生成（Class-conditional）
- [ ] 文本引导生成
- [ ] 图像修复（Inpainting）
- [ ] 超分辨率
- [ ] 风格迁移

---

## 💬 获取帮助

遇到问题？按顺序尝试：

1. 查看 `TIFF_TRAINING_README.md` 的FAQ
2. 运行 `check_tiff_data.py` 检查数据
3. 检查错误信息
4. 减小批次大小或分辨率
5. 查看示例配置文件

---

## ✅ 验证清单

训练前检查：

- [ ] Python 3.8+ 已安装
- [ ] CUDA GPU 可用
- [ ] 依赖包已安装
- [ ] TIFF文件准备好
- [ ] 至少30张图像
- [ ] 图像尺寸合适
- [ ] 足够的硬盘空间（50GB+）

---

**一切就绪！开始您的LDM训练之旅吧！🚀**

